# 模块职责概览

> 目的：帮助架构师与工程团队快速理解 `flare-im-core` 内各个服务的职责边界、关键依赖、配置要点以及扩展钩子位置，确保在大规模消息场景下“各司其职、协同高效”。

---

## 总览

| 模块 | 角色定位 | 关键职责 | 主要依赖/接口 |
|------|----------|----------|---------------|
| `flare-core-gateway` | 统一入口网关 | 聚合消息/推送/媒体/信令 gRPC 接口；按照租户转发请求 | `SIGNALING_SERVICE_ENDPOINT`、`MESSAGE_ORCHESTRATOR_ENDPOINT`、`PUSH_SERVICE_ENDPOINT`、`MEDIA_SERVICE_ENDPOINT` |
| `flare-access-gateway` | 客户端接入层 | WebSocket/QUIC 长连接、JWT 认证、会话登记、心跳 | `signaling_endpoint`、`message_endpoint`、`push_endpoint`（来自 `services/access_gateway.toml` 或环境变量） |
| `flare-message-orchestrator` | 消息编排 | PreSend 强校验 + Kafka 事件入队，统一驱动存储/推送等订阅者 | Kafka / Redis / Hook 配置（参见 `config/services/message_orchestrator.toml`） |
| `flare-storage/writer` | 持久化消费者 | 订阅 `storage-messages` 事件并写入数据库/缓存 | Kafka `storage-messages` Topic、数据库连接配置 |
| `flare-storage/reader` | 查询服务 | 提供消息查询 / 会话查询 / 撤回等接口 | `core-gateway`、DB/Redis、(预留) Query Hook |
| `flare-push/proxy` | 推送入队 | 接收业务推送请求，写入 Kafka 任务 | Kafka、Hook（后置通知） |
| `flare-push/server` | 推送调度 | 计算在线状态、生成推送任务、交付给 worker | Redis 在线状态、Delivery Hook |
| `flare-push/worker` | 推送执行 | 执行即时/离线推送、ACK 上报、失败重试 | Kafka 任务、推送渠道 SDK |
| `flare-signaling/online` | 信令在线状态 | 唤醒/心跳/在线查询、租户级会话缓存 | Redis、Login/Heartbeat Hook（可扩展） |
| `flare-signaling/route` | 信令路由目录 | SVID → 后端服务映射，转发信令层请求 | etcd 服务发现、业务服务注册 |
| `flare-media` | 媒资服务 | 文件上传、转码、元数据存储 | 对象存储、数据库、Redis |

---

## 1. 接入层（Access Gateway）

- **职责**：处理客户端连接、认证、基础限流与心跳，负责与消息编排、信令、推送服务交互。
- **关键配置**：
  - `services/access_gateway.toml` 中的 `message_endpoint` 指向消息编排服务；兼容旧字段 `storage_endpoint`。
  - `services/message_orchestrator.toml` 复用 Kafka / Redis profile，统一管理 WAL 与 Hook 配置。
  - `TOKEN_*` 字段控制签发 JWT。
- **扩展能力**：可在入口层增加速率限制、黑名单等轻量 Hook，重度业务校验委托给编排层。

## 2. 消息编排层（Message Orchestrator）

- **职责**：
  1. 执行 PreSend Hook（好友/黑名单/群权限/敏感词等）；
  2. 写入 WAL（Redis）；
  3. 将消息事件发布到 Kafka；
  4. 调用 PostSend Hook（系统消息、通知、审计）。
- **配置**：
  - 环境变量 `MESSAGE_ORCHESTRATOR_*`（兼容旧的 `STORAGE_*`）。
  - Hook 配置由 `MESSAGE_ORCHESTRATOR_HOOKS_CONFIG(_DIR)` 指定，示例见 `config/hooks.example.toml`。
- **扩展点**：PreSend/PostSend Hook；Local Plugin/WebHook/gRPC 均可接入。

## 3. 存储子系统

- **Writer**：消费 `storage-messages`，将消息写入数据库并维护冗余索引；可在成功后触发 PostSend Hook（例如群系统消息）。
- **Reader**：提供查询、撤回、删除等读接口；后续可在 Query Hook 中实现脱敏或视图过滤。
- **Model**：统一的消息结构转换层，保证落库与 Kafka 之间的格式一致性。

## 4. 推送子系统

- **Proxy**：接收业务推送请求，写入 `push-tasks` Kafka 主题。
- **Server**：根据在线状态判定，派发推送任务；支持 Delivery Hook 收集送达数据。
- **Worker**：执行实际推送（信令通道/第三方厂商），处理 ACK、重试、失败告警。

## 5. 信令子系统

- **Online**：负责登录鉴权、心跳、在线状态维护；使用 Redis 缓存，暴露 gRPC 接口给 access gateway。
- **Route**：维护 SVID → 服务实例映射，为信令集群提供跨系统路由；无状态，可水平扩展。

## 6. 核心网关与媒体

- **Core Gateway**：统一聚合 gRPC 动作，面向业务暴露单一入口，通过环境变量或配置指向各子服务（含消息编排）。
- **Media**：提供媒资上传/转码/读取能力，与消息模块解耦。

---

## 7. 配置与运行建议

- **env 兼容性**：新推荐变量以 `MESSAGE_ORCHESTRATOR_*` 开头，保留 `STORAGE_*` 作为兼容路径；网关通过 `MESSAGE_ORCHESTRATOR_ENDPOINT` 访问消息编排层。
- **运行命令**：
  - `cargo run --bin flare-message-orchestrator`
  - `cargo run --bin flare-storage-writer`
  - `cargo run --bin flare-storage-reader`
  - `cargo run --bin flare-push-proxy` / `flare-push-server` / `flare-push-worker`
  - `cargo run --bin flare-signaling-online` / `flare-signaling-route`
  - `cargo run --bin flare-access-gateway` / `flare-core-gateway`
- **监控重点**：Kafka 发布耗时、Hook 成功率、Redis WAL 积压、推送任务积压、Route 注册健康度。

---

## 8. 与 Hook 体系的协同

- 入口层 → Orchestrator：快速失败轻量逻辑，重度校验集中在 Orchestrator。
- Orchestrator → 下游订阅者：通过 Kafka 事件驱动，Writer/Push/BI 等独立扩展。
- Delivery Hook：由推送服务负责（送达即触发），可将反馈写入 BI 或 CRM。
- Query Hook（预留）：Reader 层可在未来加入，满足脱敏/视图要求。

---

## 9. 下一步建议

1. 为 `flare-message-orchestrator` 增加专属配置文件（可选），用以集中管理 Kafka/Redis Profile；目前使用环境变量亦可满足需求。
2. 在 Access Gateway 与 Route 层补充入口 Hook/路由 Hook 示例，形成完整的 Hook 使用闭环。
3. 对 Makefile 与部署脚本进行统一维护，确保一键启动时自动依赖消息编排服务。

---

如需更详细的流程设计与 Hook 方案，请参考《消息管道扩展指南》《消息 Hook 场景实战指南》《消息上下行调度架构》。
