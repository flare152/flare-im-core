# Push Server 服务配置
[services.push_server]

# ============================================
# 基础配置
# ============================================

# Kafka 配置 profile 名称（引用 base.toml 中的 [kafka.push]）
kafka = "push"

# Redis 配置 profile 名称（引用 base.toml 中的 [redis.session_store]）
redis = "session_store"

# Consumer Group 名称
consumer_group = "push-server"

# 消息 Topic 配置
message_topic = "push-messages"
notification_topic = "push-notifications"
task_topic = "flare.im.push.tasks"

# Kafka 超时配置（毫秒）
kafka_timeout_ms = 5000

# Redis 在线状态 TTL（秒）
online_ttl_seconds = 3600

# 默认租户 ID
default_tenant_id = "default"

# Hook 配置
hook_config = "config/hooks.toml"
# hook_config_dir = "config/hooks.d"

# ============================================
# 批量消费配置
# ============================================

# 单次拉取最大记录数
max_poll_records = 500

# 最小拉取字节数（1MB = 1048576 bytes）
fetch_min_bytes = 1048576

# 最大等待时间（毫秒）
fetch_max_wait_ms = 100

# ============================================
# 批量查询在线状态配置
# ============================================

# 批量查询在线状态的大小
online_status_batch_size = 100

# 在线状态查询超时（毫秒）
online_status_timeout_ms = 50

# ============================================
# Gateway Router 配置
# ============================================

# Gateway Router 连接池大小（每个 gateway_id 一个连接）
gateway_router_connection_pool_size = 10

# Gateway Router 连接超时（毫秒）
gateway_router_connection_timeout_ms = 5000

# Gateway Router 连接空闲超时（毫秒，5分钟）
gateway_router_connection_idle_timeout_ms = 300000

# Gateway 部署模式：single_region | multi_region
gateway_deployment_mode = "single_region"

# 本地 Gateway ID（多地区部署时使用，单地区部署可留空）
# local_gateway_id = "gateway-beijing-1"

# ============================================
# 推送重试配置（Gateway 推送失败重试）
# ============================================

# 最大重试次数
push_retry_max_attempts = 3

# 初始重试延迟（毫秒）
push_retry_initial_delay_ms = 100

# 最大重试延迟（毫秒）
push_retry_max_delay_ms = 5000

# 重试退避乘数
push_retry_backoff_multiplier = 2.0

# ============================================
# ACK 超时重试配置（区别于推送重试，避免 Kafka 阻塞）
# ============================================

# ACK 超时重试初始延迟（毫秒，较短，避免阻塞 Kafka）
ack_retry_initial_delay_ms = 50

# ACK 超时重试最大延迟（毫秒，较短，避免阻塞 Kafka）
ack_retry_max_delay_ms = 1000

# ============================================
# ACK 超时配置
# ============================================

# ACK 超时时间（秒）
ack_timeout_seconds = 30

# ACK 监控间隔（秒）
ack_monitor_interval_seconds = 1

# ACK 监控性能优化配置
# 每次 SCAN 的 keys 数量（避免一次性扫描太多）
ack_scan_batch_size = 500

# Pipeline 批量获取的批次大小（避免单个 Pipeline 太大）
ack_pipeline_batch_size = 1000

# 批量处理超时事件的批次大小
ack_timeout_batch_size = 100

# 并发处理超时事件的最大数量（使用信号量控制）
ack_timeout_concurrent_limit = 50

# ============================================
# 离线推送队列配置
# ============================================

# 离线推送 Topic
offline_topic = "flare.im.push.offline"

# 死信队列 Topic
dlq_topic = "flare.im.push.dlq"

# ACK Topic（从 Push Proxy 消费客户端 ACK）
ack_topic = "flare.im.push.acks"

# ============================================
# ACK 服务配置（集成到 Push Server 配置中）
# ============================================

[services.push_server.ack]
# Redis 默认过期时间（秒）
redis_ttl = 3600

# 内存缓存容量
cache_capacity = 10000

# 批量处理间隔（毫秒）
batch_interval_ms = 100

# 批量处理大小
batch_size = 100
