# 消息管道扩展指南

> **目标**：在保证 `flare-im-core` 核心能力稳定的前提下，向业务系统提供零侵入的扩展接口，让任何业务逻辑（风控、审核、统计、通知等）都能无缝接入亿级消息链路，而无需修改核心代码。
>
> **读者**：架构师、业务后端负责人、平台/中台团队
>
> **通信方式**：所有 Hook/Plugin 默认通过 gRPC 交互，遵循统一的 `flare.proto` 扩展契约；当接入第三方系统时，可启用 WebHook（HTTP）适配层。

---

## 1. 设计原则

- **零侵入**：业务逻辑永远通过扩展点（Hook / Plugin / Webhook）接入；`flare-im-core` 不依赖任何具体业务包。
- **可插拔**：支持"开启/关闭/灰度"，按租户、会话类型、消息类型维度配置；热更新不影响运行流量。
- **幂等安全**：所有扩展点都在统一的幂等框架内运行，避免消息重复处理导致的副作用。
- **异步优先**：耗时操作（回调、通知、存档等）默认异步，保证核心写链路延迟稳定。
- **可观测**：每一个扩展点都能被追踪、监控、限流、熔断。

---

## 2. 消息主线回顾

```text
Client → Access Gateway → flare-core-gateway
  → flare-im-core (SendMessageCommand)
      ① Pre-Send Hooks (同步)
      ② MessageEvent -> Kafka
  → Writer (持久化 + Post-Send Hooks → 异步)
  → Reader (视图 / 索引)
  → Push 系列服务
```

- **同步阶段**：`Pre-Send Hooks` 运行在接入网关返回结果之前，用于硬限制（校验、封禁、额度控制等）。
- **异步阶段**：`Post-Send Hooks` 运行在消息落库成功之后，用于通知、BI、推荐、离线推送等软业务。

---

## 3. 扩展点总览

| 扩展点 | 触发阶段 | 接入方式 | 适用场景 | SLA 要求 |
|--------|----------|----------|----------|----------|
| `PreSendHook` | 发送前 | 进程内（同步） | 鉴权、文案审核、余额校验、风控 | < 5ms / 次 |
| `PostSendHook` | 落库后 | 进程外（异步） | 通知、统计、推荐、埋点、对账 | < 500ms / 次 |
| `DeliveryHook` | 推送完成后 | 事件流（Kafka） | ACK 追踪、回执分析、CRM | 可配置 |
| `RecallHook` | 消息撤回 | 进程内 + 事件流 | 数据补偿、审计 | 按需 |

> 所有 Hook 都位于 `flare-im-core/application/hooks/` 下的统一注册中心，业务通过配置文件、租户控制台或 etcd 动态注入。

---

## 4. Pre-Send 可扩展性

### 4.1 编程模型

```rust
#[async_trait]
pub trait PreSendHook: Send + Sync {
    async fn handle(&self, ctx: &HookContext, msg: &mut MessageDraft) -> HookResult;
}

pub enum HookResult {
    Continue,
    Stop { error: FlareError },
}
```

- `ctx`：包含 `tenant_id`、`session_id`、`user_id`、链路追踪信息、Feature Flag 等。
- `MessageDraft`：可在允许范围内修改（例如补全默认字段、追加标签），所有修改都会被记录。
- `Stop`：立即终止消息发送，并将 `FlareError` 回传至客户端。

### 4.2 注册方式

1. **配置式（推荐）**：在 `config/hooks.toml` 内按租户/会话类型声明启用的 Hook 列表；热加载通过 etcd watch 实现。
2. **代码式**：业务提供静态库，通过 `flare-server-core::plugin::register_prefixed` 在启动阶段注入。
3. **远程调用（gRPC 标准）**：使用 `GrpcPreSendAdapter`，按租户配置远程 gRPC Endpoint，自动携带租户上下文与链路追踪信息。
4. **远程调用（WebHook 可选）**：针对第三方系统保留 `WebhookPreSendAdapter`，适用于 HTTP/REST 服务。

### 4.3 幂等与限流

- `HookContext` 内置 `idempotency_key = hash(tenant, session, client_msg_id)`；基础设施统一做一次性保障。
- 每个 Hook 可配置 `rate_limit` 与 `concurrency_limit`，默认为 10 万 QPS / 100 并发。

---

## 5. Post-Send 可扩展性

### 5.1 事件驱动模型

```text
Kafka Topic: flare.im.message.persisted
Payload: MessagePersistedEvent { message, tenant, metadata }
Consumer: PostSendDispatcher
```

`PostSendDispatcher` 读取事件后，根据租户配置并行执行多个处理器，每个处理器独立隔离。推荐实现：

- **WebHookProcessor / GrpcCallbackProcessor**：分别支持 HTTP 与 gRPC 回调，默认推荐 gRPC；配置双方重试策略与超时时间。

### 5.2 重试策略

- 默认使用指数退避，重试 5 次；超过阈值后进入 `dead-letter` 队列，触发告警。
- 支持使用 `ProcessingGuarantee::AtLeastOnce | AtMostOnce` 控制幂等策略。

### 5.3 回调结果可视化

- Prometheus 指标：`post_send_hook_success_total`, `post_send_hook_latency_bucket`
- 提供 Grafana 模板，与租户、消息类型、Hook 名称维度组合。
- TraceID 来自客户端请求，可通过 Jaeger 搜索定位。

---

## 6. Delivery & Recall 扩展

### 6.1 DeliveryHook

- 触发条件：客户端 ACK、系统推送 ACK、离线投递 ACK。
- 事件格式：`DeliveryEvent { message_id, user_id, ack_type, timestamp }`
- 典型应用：送达率统计、用户行为分析、客服系统联动。

### 6.2 RecallHook

- 同步阶段验证权限 → 异步阶段通知业务。
- 支持在 Post-Send 时缓存 Hook 结果，以便撤回时回滚。

---

## 7. 配置管理

| 配置项 | 说明 | 位置 | 默认值 |
|--------|------|------|--------|
| `hooks.pre_send` | 租户级 Hook 列表 | `config/hooks.toml` | 空 |
| `hooks.post_send` | 租户级异步 Hook 列表 | `config/hooks.toml` | 监控/日志 |
| `hooks.retry_strategy` | 重试次数/退避 | `config/hooks.toml` | 5 次 / 指数 |
| `hooks.timeout_ms` | 每个 Hook 超时 | etcd / Redis | 5_000 |
| `hooks.rate_limit` | 限流阈值 | etcd / Redis | 100k/s |

> 通过 `flare-im-core` 自带的配置热更新模块（etcd watch + Redis 缓存）秒级生效。
>
> 消息编排服务 `flare-message-orchestrator` 会在启动时读取 `config/hooks.toml`（可通过环境变量 `MESSAGE_ORCHESTRATOR_HOOKS_CONFIG` 或 `MESSAGE_ORCHESTRATOR_HOOKS_CONFIG_DIR` 指定文件/目录，并兼容旧的 `STORAGE_HOOKS_CONFIG*`），并在消息持久化流程中自动执行对应的 PreSend/PostSend Hook。可选的 `config/services/message_orchestrator.toml` 用于集中声明 Kafka/Redis Profile 以及 Hook 配置路径。
>
> 配置示例：见 `config/hooks.example.toml`。复制为 `config/hooks.toml` 后即可按租户启用。

---

## 8. 集成指南

1. **定义 Hook**：业务团队实现 gRPC Server（推荐）或 WebHook/本地 Hook，遵循统一的请求/响应模型。
2. **声明配置**：在平台配置中心（或 `hooks.toml`）中启用，并设置限制参数。
3. **关联租户**：支持按租户/业务线/会话类型灵活组合。
4. **验证联调**：使用 `POST /internal/hooks/validate` 或 `cargo run --bin flare-core-gateway --features hook-debug`。
5. **观察指标**：接入后监控延迟、成功率、限流情况，必要时调整阈值。

---

## 9. 运维保障

- **熔断**：当 Hook 连续失败率 > 30% 或延迟超过 SLA 自动熔断，切换到降级逻辑（可配置）。
- **灰度发布**：支持按百分比、租户白名单逐步开启；所有事件带 `feature_version`，便于回溯。
- **安全**：WebHook 支持签名验证、IP 白名单；内部 Hook 运行时受 Rust 类型系统保护，禁止 panic。
- **审计**：所有 Hook 执行记录写入审计日志（Message ID、Hook 名称、结果、耗时）。

---

## 10. FAQ

**Q: 业务要新增“文本走自研风控”怎么办？**  
A: 实现 `PreSendHook`，部署成独立 crate 或 WebHook 服务，配置中心开启对应租户即可。

**Q: 某个 Hook 失败会影响核心链路吗？**  
A: 仅当 Hook 明确返回 `Stop` 时阻断；其它情况最多降级或熔断，`flare-im-core` 核心流程不受影响。

**Q: 后置通知很慢怎么办？**  
A: 使用异步队列，或配置 `max_concurrency`，必要时横向扩容 Hook 实例；系统有重试+死信保障。

**Q: 业务如何做版本控制？**  
A: Hook 提供 `semver` 标记；平台支持按 `tenant → version` 灰度，旧版本在配置中保留即可。

---

## 11. 参考

- [`doc/ARCHITECTURE_SUMMARY.md`](../ARCHITECTURE_SUMMARY.md)
- [`doc/PROJECT_STRUCTURE.md`](../doc/PROJECT_STRUCTURE.md)
- [`flare-proto`](../../flare-proto) 中的 `message.proto`

如需更多接入示例或脚手架，请联系架构团队或查看 `examples/` 目录下的 Hook 示例工程。
