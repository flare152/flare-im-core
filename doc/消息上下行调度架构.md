# 消息上下行调度架构

> **提示**：当前文档保留详细描述，设计阶段快速了解可参考根仓库 `doc/MESSAGE_PIPELINE.md` 的概要版本。

> 角色定位：本文从软件架构师视角，统一描述消息在 `flare-access-gateway` 进出系统的流程、调度模块职责、队列驱动方式，以及与 Route/Hook 体系的协同策略，帮助业务系统在保障一致性的前提下获得更高的灵活性。

---

## 1. 整体视图

```text
(Client / SDK)
      ↓  长连接 / gRPC
[Access Gateway]
      ↓  统一接入 & 基础前置校验
  (JWT / 限流 / Entrance Hook)
[Message Orchestrator]
  (PreSend Hook + Redis WAL + Kafka ACK)
      ↓  Kafka 事件流
 ├── [Storage Writer]      (幂等校验 + Tx 写入 + PostSend Hook)
 ├── [Push Pipeline]       (Delivery Hook + ACK 回传 + 重试策略)
 ├── [Notification / BI]   (DLQ + 回放)
 └── [...]                (基于 Topic 拓展)

下行消息：业务服务 → Route (SVID 映射 + 健康检测) → 信令连接 → 用户终端
```

- **Access Gateway**：统一入口，负责认证、限流、基础合法性检测；必要时可提供“入口 Hook”扩展点，但不承担复杂业务逻辑。
- **Message Orchestrator**：执行强一致校验、编排 Hook、封装领域事件并写入消息队列，是系统“消息真源”。
- **Kafka 事件流**：作为消息处理的中枢，推送、持久化、通知等模块全部通过订阅同一流进行解耦和扩展。
- **Route 服务**：信令系统与其他业务子系统的无状态交互层，负责 SVID → 后端服务的映射，下行推送也通过 Route 按连接转发。

---

## 2. 上行流程与 Hook 布局

### 2.1 Access Gateway
- **职责**：长连接接入、JWT/Token 认证、心跳、简单参数校验（例如 payload 大小、语法）。
- **可选 Hook**：入口级速率限制、账号状态校验、埋点。失败可直接返回客户端，减少后续负载。

### 2.2 Message Orchestrator
- **职责**：
  1. 载入 `flare-im-core` 的 PreSend Hook 注册表（好友/黑名单/群权限/敏感词等）；
  2. 仅当所有强约束 Hook 通过时，才视为消息合法；
  3. 将消息标准化并生产到 Kafka 事件流；
  4. 在成功 persist 事件后调用 PostSend Hook（系统消息、通知业务、审计等）。
- **关键点**：
  - 强一致逻辑集中在此，确保所有入口共享相同行为。
  - Hook 通过配置中心（`hooks.toml` + etcd）按租户/会话/消息类型热切换。
  - `config/services/message_orchestrator.toml` 可统一声明 Kafka/Redis profile、Hook 配置路径，配合环境变量实现灵活覆盖。

### 2.3 Kafka 事件
- **事件内容**：`message_id`、`session_id`、消息主体、租户信息、Hook 标签等。
- **下游约定**：保证幂等（基于 message_id）、带上 partition key（session/user），以便推送/存储遵守有序性。

---

## 2.1.1 网关进入后的全链路

1. **长连接接入（flare-access-gateway）**  
   - 客户端通过 WebSocket/QUIC 建立长连接，发送 `SendMessage` 指令。  
   - 网关完成 JWT 校验、心跳续期及基础参数检查后，将请求转发至 `flare-message-orchestrator` 的 gRPC 接口 `StoreMessage`。  
   - 若配置了入口级 Hook，可在此阶段快速拦截黑名单或高风险请求。  

2. **消息编排（flare-message-orchestrator）**  
   - 构造标准化 `HookContext` 并执行 **PreSend Hook**（关系/风控/内容）。失败直接返回网关，由网关将错误推送回客户端。  
   - 消息通过 `MessageSubmission` 归一化后写入 Redis WAL，待 Kafka 返回 ACK 后再清理 WAL，保证消息落 Kafka 之前不会丢失。  
   - 编排层在 Kafka 投递成功后执行 **PostSend Hook**，用于发布系统事件、通知外部业务或写审计。  

3. **持久化写入（flare-storage/writer）**  
   - 订阅 `storage-messages`，基于 message_id + Redis WAL 做幂等校验，确保重放不重复写入。  
   - 写入 MongoDB/TimescaleDB/Redis Cache，并将“消息已落地”事件写入 Kafka Topic `push-messages`（供推送使用）及其他衍生 Topic（BI/审计视需要配置）。  
   - 若需要 PostSend 扩展，可触发存储层 Hook（例如群系统消息或业务通知）。  

4. **推送调度（flare-push-server）**  
   - 消费 `push-messages` 与 `push-notifications` Topic，查询 `Redis session_store` 判断在线状态。  
   - 执行推送链路的 **PreSend Hook**，决定是否投递、是否切换离线渠道，并允许调整推送内容。  
   - 生成 `PushDispatchTask` 写入 Kafka Topic `push-tasks`，成功后触发 **PostSend Hook** 做审计或异步通知。  

5. **推送执行（flare-push-worker）**  
   - 消费 `push-tasks`，根据在线状态选择执行器：  
     - **在线用户**：通过 `flare-core-gateway → flare-access-gateway → flare-signaling` 直接推送到该 WebSocket/QUIC 连接，并等待 ACK。  
     - **离线用户**：调用配置的第三方渠道（APNs/FCM/SMS 等），必要时持久化离线通知并记录 Delivery Hook 回执。  
   - 投递成功后触发 **Delivery Hook**，将送达结果写回业务或监控系统，并根据需要记录到 `delivery-status` Topic。  

6. **回推结果（flare-access-gateway）**  
   - 当推送执行器选择在线分支时，最终由 `flare-access-gateway` 通过现有长连接向客户端发送实时通知，并携带 Kafka message_id/ack 信息。  
   - 若为离线渠道，客户端重新上线后，Reader 侧消费同步消息时会再次通过网关下发，或由离线渠道自身触达到端设备。  

> **Kafka 主题一览**：
> - `storage-messages`：消息编排 → 存储 Writer 的主事件流（WAL + ACK）。  
> - `push-messages` / `push-notifications`：存储 Writer / 推送 Proxy 产出的实时通知流。  
> - `push-tasks`：推送 Server → Worker 的任务分发流（含重试次数/延迟重试标记）。  
> - `delivery-status`：Delivery Hook 回执、ACK、失败原因（可配 DLQ）。  

```text
┌────────────────────────────────────────────────────────┐
│                    客户端层 (Client)                    │
│   iOS | Android | Web | Desktop                        │
└────────────────────────────────────────────────────────┘
                         │ WebSocket / QUIC
                         ▼
┌────────────────────────────────────────────────────────┐
│         接入网关 (flare-access-gateway)                 │
│  - JWT 校验 / 心跳 / Entrance Hook                      │
│  - 写入临时会话缓存                                     │
└────────────────────────────────────────────────────────┘
                         │ gRPC StoreMessage
                         ▼
┌────────────────────────────────────────────────────────┐
│        消息编排 (flare-message-orchestrator)            │
│  - PreSend Hook + Redis WAL + Kafka ACK                 │
│  - PostSend Hook (系统事件)                             │
└────────────────────────────────────────────────────────┘
                         │ Kafka `storage-messages`
                         ▼
┌────────────────────────────────────────────────────────┐
│        持久化写入 (flare-storage/writer)                │
│  - 幂等校验 (WAL + message_id)                         │
│  - MongoDB/Timescale/Redis                              │
│  - Kafka `push-messages` / `push-notifications`         │
└────────────────────────────────────────────────────────┘
                         │ Kafka `push-messages`
                         ▼
┌────────────────────────────────────────────────────────┐
│         推送调度 (flare-push-server)                    │
│  - Redis 在线状态 / PreSend                            │
│  - Kafka `push-tasks`                                  │
│  - PostSend Hook (审计/BI)                             │
└────────────────────────────────────────────────────────┘
                         │ Kafka `push-tasks`
                         ▼
┌────────────────────────────────────────────────────────┐
│         推送执行 (flare-push-worker)                    │
│  - 在线信令推送 / 离线渠道                              │
│  - Delivery Hook：ACK / 重试 / DLQ                     │
└────────────────────────────────────────────────────────┘
           │ 在线路径                              │ 离线路径
           ▼                                        ▼
 ┌──────────────────────┐                ┌──────────────────────────┐
 │ flare-core-gateway    │                │ 离线推送渠道 (APNs/FCM…) │
 │ - 多租户路由入口       │                └──────────────────────────┘
 └──────────┬───────────┘
            │ gRPC + ACK
            ▼
 ┌────────────────────────┐
 │ flare-signaling/route   │
 │ - SVID → 服务映射        │
 │ - 多副本健康检测         │
 └──────────┬────────────┘
            │ 指令/心跳
            ▼
 ┌────────────────────────┐
 │ flare-access-gateway    │
 │ - 长连接写入 / ACK 回传   │
 └──────────┬────────────┘
            │ WebSocket/QUIC
            ▼
 ┌────────────────────────┐
 │ 终端客户端              │
 └────────────────────────┘
```

### 2.1.2 在线回推路径
1. **Push Worker**：在 `push-tasks` 中读取任务后，若检测到目标用户在线，会调用在线推送执行器，通过内部 gRPC 将推送请求交给统一网关链路。  
2. **flare-core-gateway**：作为服务汇聚层，负责将推送请求映射到对应租户/区域的 `flare-signaling` 集群，并补齐 Trace / Tenant 元数据。  
3. **flare-signaling**：根据用户的会话映射（SVID → Access Gateway 节点），找到目标长连接实例，并生成路由命令。  
4. **flare-access-gateway**：维护实际的 WebSocket/QUIC 连接池，将消息封装为下行帧写入对应连接。一旦写入成功，会将 ACK 结果返回给 Push Worker。  
5. **客户端**：实时收到消息后可回传已读/回执，沿原链路逆向上报，最终触发 Delivery Hook 及业务侧回调。  

> 在线回推涉及的关键模块：`flare-push-worker` → `flare-core-gateway` → `flare-signaling` → `flare-access-gateway` → Client；其中 `flare-access-gateway` 与客户端之间保持长连接，保障毫秒级推送时延。

---

## 3. 下游订阅者

### 3.1 Storage Writer
- 消费事件后写入持久化存储（PostgreSQL/Timescale、Mongo、Redis Cache）。
- 可在写成功后触发异步 PostSend Hook（系统消息落库、群解散/退出通知）。

### 3.2 Push Pipeline
- `flare-push-proxy/server/worker` 消费事件，判断用户在线与否，执行即时推送或离线存储。
- 支持 Delivery Hook：消息送达后通知业务（ACK、行为分析、积分等）。

### 3.3 其他业务订阅者
- 例如运营通知、风控、推荐、BI，可按需订阅 Kafka 流，完全不影响主链路。

---

## 4. Route 服务定位

- **SVID 注册**：各后端业务（IM、客服、AI Bot 等）以 SVID 形式向 Route 注册自身地址。
- **登录流程**：Access Gateway / Signaling 登录时，拿到 SVID → Route 查表 → 转发给对应后端服务。
- **下行转发**：后端业务想推送下行消息，调用 Route，根据 SVID + 用户信息，让信令连接完成实际下发。
- **在线状态协同**：`flare-signaling/online` 负责记录会话与心跳，Route 基于在线模块维护的会话映射决定下行路由目标。
- **特点**：
  - Route 无状态，可水平扩容；节点故障不影响整体。
  - 仅负责“路由映射”，不做业务逻辑或校验。
  - 与 orchestrator 协作：上行事件进入队列，下行指令通过 Route 派发给终端。

---

## 5. 下行调度与 Hook

- **业务触发**：
  1. 业务服务（例如群解散、系统通知）写入“下行队列”或直接调用 orchestrator 的 PostSend Hook。
  2. Hooks 可以在 PostSend 阶段创建“系统消息”事件，再由推送/存储订阅者消费。
- **Route 转发**：收到业务下行指令，根据连接状态决定即时推送或转发给离线存储服务。
- **Hook 点建议**：
  - PostSend：发布系统消息 + 通知业务完成解散/退出。
  - Delivery：确认终端 ACK 后，打点或触发后续流程（收费、任务）。

---

## 6. Hook 体系布置建议

| 层级 | Hook 类型 | 示例场景 | 是否阻断 |
|------|-----------|----------|----------|
| Access Gateway | Entrance Hook（可选） | 账号封禁、风险提示 | 是 |
| Message Orchestrator | PreSend | 好友/黑名单、群权限、敏感词 | 是 |
| Message Orchestrator | PostSend | 群解散通知、审计、BI | 否（可配置） |
| Push Worker | Delivery | 送达确认、终端过滤 | 否（通常） |
| Reader | Query | 数据脱敏、视角筛选 | 是（根据配置） |

- 强约束逻辑集中在 orchestrator，确保所有入口一致。
- 其它层级的 Hook 用于增强灵活性，但不应破坏核心一致性。
- 所有 Hook 基于 `flare-im-core` 统一 Traits/Registry，实现方式可选 gRPC/WebHook/Local Plugin。

---

## 7. 配置与部署

- **环境变量**：
  - `STORAGE_HOOKS_CONFIG` / `STORAGE_HOOKS_CONFIG_DIR` 指定 orchestrator 加载的 Hook 配置路径。
  - 其余服务（Push、Reader）亦可参考同样机制加载子集 Hook。
- **热更新**：建议通过 etcd watch / 配置中心动态刷新 Hook 列表，无需重启进程。
- **监控指标**：统一输出 `hook_execution_duration_seconds`、`hook_failure_total`、`hook_timeout_total` 等指标。
- **容错策略**：配合 `require_success`、`timeout_ms`、`max_retries`、死信队列（DLQ）等参数保障稳定性。

---

## 8. 整体收益

- **清晰边界**：接入 → 调度 → 事件流 → 多订阅者 → Route 下行，责任划分明确。
- **一致性**：强约束集中在 orchestrator，保证所有入口的业务规则不变。
- **扩展性**：Kafka 驱动的事件流让推送、存储、通知等业务可以独立水平扩展。
- **灵活性**：Hook 体系在各层提供必要扩展点，满足差异化业务需求。
- **容错性**：Route/Orchestrator 均可无状态扩容，单点故障不会阻断消息链路。

---

## 9. 可靠性机制

| 层级 | 机制 | 说明 |
|------|------|------|
| Access Gateway | 会话缓存 + ACK | 维护在线连接状态，收到推送 ACK 后回写 Delivery Hook。
| Message Orchestrator | Redis WAL + Kafka ACK + 幂等 message_id | 消息写入 WAL 后再投递 Kafka，收到 ACK 后清理 WAL，确保至少一次投递，同时记录 message_id 保证下游幂等。
| Kafka | 多副本 + ISR 监控 + 重试 | 使用带副本的 Topic，Producer 启用 `acks=all`，失败重试并写入告警。
| Storage Writer | 幂等检查 + 事务写入 + 死信队列 | 基于 message_id、WAL Hash 做去重，数据库和缓存写入封装事务，失败时写入 DLQ 等待人工处理或二次回放。
| Push Pipeline | Delivery Hook + 重试 + 延迟队列 | 推送失败时根据策略重试，超过阈值写入 `push-dlq` 并同步告警；Delivery Hook 负责记录结果。
| Push Worker | ACK 反馈 + 扩展指标 | 在线推送路径等待 signaling/connection ACK，离线路径记录第三方渠道回执；指标同步到监控系统。
| Route / Signaling | SVID 健康检测 + 节点降级 | Route 查询时对目标服务做健康探测，失败时切换备份 SVID 或回退到离线存储。
| 配置/监控 | 指标 + 告警 + 自愈脚本 | 所有关键链路暴露指标（成功率、重试次数、DLQ 深度），告警触发后可调用自愈脚本（重启消费、清理 WAL 等）。

>
> - **至少一次投递**：Redis WAL + Kafka ACK + Storage 幂等保证消息不会丢失；
> - **至多一次投递**：上游 Hook、Storage 幂等和 Delivery Hook 去重，避免重复对终端推送；
> - **最终一致性**：Push Worker 在 ACK 或 DLQ 后更新回执，Reader/BI 可通过回放消费补偿；
> - **可观测性**：metrics/log/trace 覆盖编排、存储、推送、Route 等关键节点。

---

## 10. 参考文档

- [`消息管道扩展指南`](消息管道扩展指南.md)：Hook 体系与配置。
- [`消息 Hook 场景实战指南`](消息Hook场景实战指南.md)：常见场景与 gRPC/WebHook/Plugin 示例。
- [`flare-message-orchestrator`](../flare-message-orchestrator) & [`flare-push`](../flare-push) 源码：现有 Hook 集成与订阅者实现。
- `doc/消息流程图_v2.drawio`：配套的可视化流程图。