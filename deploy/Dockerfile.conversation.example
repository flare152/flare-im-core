# Flare Session Service Dockerfile 示例
#
# 使用方法:
#   docker build -f deploy/Dockerfile.session -t flare-session:latest .

# 构建阶段
FROM rust:1.85 as builder

WORKDIR /app

# 安装构建依赖
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# 复制工作空间配置
COPY Cargo.toml Cargo.lock ./
COPY flare-im-core/Cargo.toml ./flare-im-core/
COPY flare-session/Cargo.toml ./flare-im-core/flare-session/

# 构建依赖（利用 Docker 缓存）
RUN mkdir -p flare-im-core/flare-session/src && \
    echo "fn main() {}" > flare-im-core/flare-session/src/main.rs && \
    cargo build --release -p flare-session --bin flare-session || true

# 复制源代码
COPY . .

# 构建应用
RUN touch flare-im-core/flare-session/src/main.rs && \
    cargo build --release -p flare-session --bin flare-session

# 运行时阶段
FROM debian:bookworm-slim

WORKDIR /app

# 安装运行时依赖
RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3 \
    && rm -rf /var/lib/apt/lists/*

# 复制可执行文件
COPY --from=builder /app/target/release/flare-session /app/flare-session

# 复制配置文件（只读）
COPY config /app/config

# 创建非 root 用户
RUN useradd -m -u 1000 flare && \
    chown -R flare:flare /app

USER flare

# 暴露端口
EXPOSE 50090

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
    CMD grpc_health_probe -addr=:50090 || exit 1

# 启动服务
CMD ["./flare-session"]

